name: åº”ç”¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

env:
  FLUTTER_VERSION: '3.35.3'

jobs:
  # æ„å»ºæ‰€æœ‰å¹³å°
  build-all:
    name: Build All Platforms
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            artifact: android-apk
            path: build/app/outputs/flutter-apk/app-release.apk
          - os: ubuntu-latest
            platform: web
            artifact: web-app
            path: build/web
          - os: macos-latest
            platform: ios
            artifact: ios-app
            path: build/ios/iphoneos/Runner.app
          - os: macos-latest
            platform: macos
            artifact: macos-app
            path: build/macos/Build/Products/Release
          - os: windows-latest
            platform: windows
            artifact: windows-app
            path: build/windows/x64/runner/Release
          - os: ubuntu-latest
            platform: linux
            artifact: linux-app
            path: build/linux/x64/release/bundle

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java (Android only)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
          # å®‰è£… GStreamer ä¾èµ–ï¼ˆaudioplayers æ’ä»¶éœ€è¦ï¼‰
          sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
          # å®‰è£…å…¶ä»–å¯èƒ½éœ€è¦çš„éŸ³é¢‘ä¾èµ–
          sudo apt-get install -y libasound2-dev libpulse-dev

      - name: Build Android
        if: matrix.platform == 'android'
        run: flutter build apk --release

      - name: Build Web
        if: matrix.platform == 'web'
        run: flutter build web --release

      - name: Build iOS
        if: matrix.platform == 'ios'
        run: flutter build ios --release --no-codesign

      - name: Build macOS
        if: matrix.platform == 'macos'
        run: flutter build macos --release

      - name: Build Windows
        if: matrix.platform == 'windows'
        run: flutter build windows --release

      - name: Build Linux
        if: matrix.platform == 'linux'
        run: flutter build linux --release

      - name: Check build output exists
        run: |
          echo "=== æ£€æŸ¥æ„å»ºè¾“å‡º ==="
          echo "å¹³å°: ${{ matrix.platform }}"
          echo "é¢„æœŸè·¯å¾„: ${{ matrix.path }}"
          if [ -d "${{ matrix.path }}" ]; then
            echo "âœ… æ„å»ºè¾“å‡ºç›®å½•å­˜åœ¨"
            ls -la "${{ matrix.path }}"
          else
            echo "âŒ æ„å»ºè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            find build -type d -name "*" | head -20
            echo "æŸ¥æ‰¾å¯èƒ½çš„è¾“å‡ºæ–‡ä»¶:"
            find build -name "*.exe" -o -name "*.app" -o -name "*.apk" -o -name "*.dmg" | head -10
            
            # å¯¹äºWindowsï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„è·¯å¾„
            if [ "${{ matrix.platform }}" = "windows" ]; then
              echo "=== Windows ç‰¹æ®Šæ£€æŸ¥ ==="
              echo "æ£€æŸ¥ build/windows/ ç›®å½•:"
              ls -la build/windows/ 2>/dev/null || echo "build/windows/ ä¸å­˜åœ¨"
              echo "æŸ¥æ‰¾æ‰€æœ‰ .exe æ–‡ä»¶:"
              find build -name "*.exe" 2>/dev/null || echo "æœªæ‰¾åˆ° .exe æ–‡ä»¶"
            fi
          fi

      - name: Prepare artifacts with version
        run: |
          echo "=== å‡†å¤‡å¸¦ç‰ˆæœ¬å·çš„åˆ¶å“ ==="
          VERSION="${{ github.event.inputs.version }}"
          echo "ç‰ˆæœ¬å·: $VERSION"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p artifacts
          
          # æ ¹æ®å¹³å°å¤„ç†ä¸åŒçš„æ–‡ä»¶
          case "${{ matrix.platform }}" in
            "android")
              if [ -f "${{ matrix.path }}" ]; then
                # ç¡®ä¿ artifacts ç›®å½•å­˜åœ¨
                mkdir -p artifacts
                cp "${{ matrix.path }}" "artifacts/kiri-${VERSION}.apk"
                echo "âœ… åˆ›å»º Android APK: kiri-${VERSION}.apk"
              fi
              ;;
            "web")
              if [ -d "${{ matrix.path }}" ]; then
                # ç¡®ä¿ artifacts ç›®å½•å­˜åœ¨
                mkdir -p artifacts
                # ç¡®ä¿ ../../artifacts ç›®å½•å­˜åœ¨ï¼ˆåœ¨ cd ä¹‹å‰å†æ¬¡ç¡®è®¤ï¼‰
                mkdir -p ../../artifacts
                cd "${{ matrix.path }}"
                zip -r "../../artifacts/kiri-${VERSION}-web.zip" .
                cd ../..
                echo "âœ… åˆ›å»º Web å‹ç¼©åŒ…: kiri-${VERSION}-web.zip"
              fi
              ;;
            "ios")
              if [ -d "${{ matrix.path }}" ]; then
                # ç¡®ä¿ artifacts ç›®å½•å­˜åœ¨
                mkdir -p artifacts
                # ç¡®ä¿ ../../artifacts ç›®å½•å­˜åœ¨ï¼ˆåœ¨ cd ä¹‹å‰å†æ¬¡ç¡®è®¤ï¼‰
                mkdir -p ../../artifacts
                # åˆ›å»º iOS åº”ç”¨çš„å‹ç¼©åŒ…
                cd "${{ matrix.path }}"
                zip -r "../../artifacts/kiri-${VERSION}-ios.zip" .
                cd ../..
                echo "âœ… åˆ›å»º iOS åº”ç”¨: kiri-${VERSION}-ios.zip"
              fi
              ;;
            "macos")
              if [ -d "${{ matrix.path }}" ]; then
                # ç¡®ä¿ artifacts ç›®å½•å­˜åœ¨
                mkdir -p artifacts
                # æŸ¥æ‰¾ .app æ–‡ä»¶
                APP_FILE=$(find "${{ matrix.path }}" -name "*.app" | head -1)
                if [ -n "$APP_FILE" ]; then
                  cp -r "$APP_FILE" "artifacts/kiri-${VERSION}.app"
                  echo "âœ… åˆ›å»º macOS åº”ç”¨: kiri-${VERSION}.app"
                fi
                # æŸ¥æ‰¾ .dmg æ–‡ä»¶
                DMG_FILE=$(find "${{ matrix.path }}" -name "*.dmg" | head -1)
                if [ -n "$DMG_FILE" ]; then
                  cp "$DMG_FILE" "artifacts/kiri-${VERSION}.dmg"
                  echo "âœ… åˆ›å»º macOS DMG: kiri-${VERSION}.dmg"
                fi
              fi
              ;;
            "windows")
              if [ -d "${{ matrix.path }}" ]; then
                # ç¡®ä¿ artifacts ç›®å½•å­˜åœ¨
                mkdir -p artifacts
                # æŸ¥æ‰¾ .exe æ–‡ä»¶
                EXE_FILE=$(find "${{ matrix.path }}" -name "*.exe" | head -1)
                if [ -n "$EXE_FILE" ]; then
                  cp "$EXE_FILE" "artifacts/kiri-${VERSION}.exe"
                  echo "âœ… åˆ›å»º Windows EXE: kiri-${VERSION}.exe"
                fi
                # æŸ¥æ‰¾ .msi æ–‡ä»¶
                MSI_FILE=$(find "${{ matrix.path }}" -name "*.msi" | head -1)
                if [ -n "$MSI_FILE" ]; then
                  cp "$MSI_FILE" "artifacts/kiri-${VERSION}.msi"
                  echo "âœ… åˆ›å»º Windows MSI: kiri-${VERSION}.msi"
                fi
                # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å•ä¸ªæ–‡ä»¶ï¼Œåˆ›å»ºæ•´ä¸ªç›®å½•çš„å‹ç¼©åŒ…
                if [ -z "$EXE_FILE" ] && [ -z "$MSI_FILE" ]; then
                  # ç¡®ä¿ ../../artifacts ç›®å½•å­˜åœ¨ï¼ˆåœ¨ cd ä¹‹å‰å†æ¬¡ç¡®è®¤ï¼‰
                  mkdir -p ../../artifacts
                  cd "${{ matrix.path }}"
                  zip -r "../../artifacts/kiri-${VERSION}-windows.zip" .
                  cd ../..
                  echo "âœ… åˆ›å»º Windows å‹ç¼©åŒ…: kiri-${VERSION}-windows.zip"
                fi
              fi
              ;;
            "linux")
              if [ -d "${{ matrix.path }}" ]; then
                # ç¡®ä¿ artifacts ç›®å½•å­˜åœ¨
                mkdir -p artifacts
                # æŸ¥æ‰¾ .AppImage æ–‡ä»¶
                APPIMAGE_FILE=$(find "${{ matrix.path }}" -name "*.AppImage" | head -1)
                if [ -n "$APPIMAGE_FILE" ]; then
                  cp "$APPIMAGE_FILE" "artifacts/kiri-${VERSION}.AppImage"
                  echo "âœ… åˆ›å»º Linux AppImage: kiri-${VERSION}.AppImage"
                fi
                # æŸ¥æ‰¾ .deb æ–‡ä»¶
                DEB_FILE=$(find "${{ matrix.path }}" -name "*.deb" | head -1)
                if [ -n "$DEB_FILE" ]; then
                  cp "$DEB_FILE" "artifacts/kiri-${VERSION}.deb"
                  echo "âœ… åˆ›å»º Linux DEB: kiri-${VERSION}.deb"
                fi
                # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å•ä¸ªæ–‡ä»¶ï¼Œåˆ›å»ºæ•´ä¸ªç›®å½•çš„å‹ç¼©åŒ…
                if [ -z "$APPIMAGE_FILE" ] && [ -z "$DEB_FILE" ]; then
                  # ç¡®ä¿ artifacts ç›®å½•å­˜åœ¨ï¼ˆåœ¨ cd ä¹‹å‰å†æ¬¡ç¡®è®¤ï¼‰
                  mkdir -p ../../artifacts
                  cd "${{ matrix.path }}"
                  tar -czf "../../artifacts/kiri-${VERSION}-linux.tar.gz" .
                  cd ../..
                  echo "âœ… åˆ›å»º Linux å‹ç¼©åŒ…: kiri-${VERSION}-linux.tar.gz"
                fi
              fi
              ;;
          esac
          
          echo "=== æœ€ç»ˆåˆ¶å“åˆ—è¡¨ ==="
          ls -la artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: artifacts/
          if-no-files-found: warn

  # åˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-all
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: List downloaded artifacts
        run: |
          echo "=== ä¸‹è½½çš„ artifacts ç»“æ„ ==="
          find . -type f -name "*.apk" -o -name "*.app" -o -name "*.exe" -o -name "*.deb" -o -name "*.tar.gz" | head -20
          echo "=== å„å¹³å°æ–‡ä»¶ ==="
          ls -la android-apk/ 2>/dev/null || echo "Android APK ä¸å­˜åœ¨"
          ls -la web-app/ 2>/dev/null || echo "Web åº”ç”¨ä¸å­˜åœ¨"
          ls -la ios-app/ 2>/dev/null || echo "iOS åº”ç”¨ä¸å­˜åœ¨"
          ls -la macos-app/ 2>/dev/null || echo "macOS åº”ç”¨ä¸å­˜åœ¨"
          ls -la windows-app/ 2>/dev/null || echo "Windows åº”ç”¨ä¸å­˜åœ¨"
          ls -la linux-app/ 2>/dev/null || echo "Linux åº”ç”¨ä¸å­˜åœ¨"
          
          echo "=== æŸ¥æ‰¾æ‰€æœ‰å¯ç”¨çš„åº”ç”¨æ–‡ä»¶ ==="
          find . -name "*.app" -o -name "*.dmg" -o -name "*.exe" -o -name "*.msi" -o -name "*.deb" -o -name "*.AppImage" | head -20

      - name: Create dynamic file list
        id: create-files
        run: |
          echo "=== åˆ›å»ºåŠ¨æ€æ–‡ä»¶åˆ—è¡¨ ==="
          VERSION="${{ github.event.inputs.version }}"
          echo "ç‰ˆæœ¬å·: $VERSION"
          
          # åˆ›å»ºæ–‡ä»¶åˆ—è¡¨
          FILE_LIST=""
          
          # æŸ¥æ‰¾æ‰€æœ‰å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶
          echo "=== æŸ¥æ‰¾åˆ¶å“æ–‡ä»¶ ==="
          
          # Android APK
          if [ -f "android-apk/kiri-${VERSION}.apk" ]; then
            FILE_LIST="$FILE_LIST
            android-apk/kiri-${VERSION}.apk"
            echo "âœ… æ·»åŠ  Android APK: kiri-${VERSION}.apk"
          fi
          
          # Web åº”ç”¨
          if [ -f "web-app/kiri-${VERSION}-web.zip" ]; then
            FILE_LIST="$FILE_LIST
            web-app/kiri-${VERSION}-web.zip"
            echo "âœ… æ·»åŠ  Web åº”ç”¨: kiri-${VERSION}-web.zip"
          fi
          
          # iOS åº”ç”¨
          if [ -f "ios-app/kiri-${VERSION}-ios.zip" ]; then
            FILE_LIST="$FILE_LIST
            ios-app/kiri-${VERSION}-ios.zip"
            echo "âœ… æ·»åŠ  iOS åº”ç”¨: kiri-${VERSION}-ios.zip"
          fi
          
          # macOS åº”ç”¨
          if [ -f "macos-app/kiri-${VERSION}.app" ]; then
            FILE_LIST="$FILE_LIST
            macos-app/kiri-${VERSION}.app"
            echo "âœ… æ·»åŠ  macOS åº”ç”¨: kiri-${VERSION}.app"
          fi
          if [ -f "macos-app/kiri-${VERSION}.dmg" ]; then
            FILE_LIST="$FILE_LIST
            macos-app/kiri-${VERSION}.dmg"
            echo "âœ… æ·»åŠ  macOS DMG: kiri-${VERSION}.dmg"
          fi
          
          # Windows åº”ç”¨
          if [ -f "windows-app/kiri-${VERSION}.exe" ]; then
            FILE_LIST="$FILE_LIST
            windows-app/kiri-${VERSION}.exe"
            echo "âœ… æ·»åŠ  Windows EXE: kiri-${VERSION}.exe"
          fi
          if [ -f "windows-app/kiri-${VERSION}.msi" ]; then
            FILE_LIST="$FILE_LIST
            windows-app/kiri-${VERSION}.msi"
            echo "âœ… æ·»åŠ  Windows MSI: kiri-${VERSION}.msi"
          fi
          if [ -f "windows-app/kiri-${VERSION}-windows.zip" ]; then
            FILE_LIST="$FILE_LIST
            windows-app/kiri-${VERSION}-windows.zip"
            echo "âœ… æ·»åŠ  Windows å‹ç¼©åŒ…: kiri-${VERSION}-windows.zip"
          fi
          
          # Linux åº”ç”¨
          if [ -f "linux-app/kiri-${VERSION}.AppImage" ]; then
            FILE_LIST="$FILE_LIST
            linux-app/kiri-${VERSION}.AppImage"
            echo "âœ… æ·»åŠ  Linux AppImage: kiri-${VERSION}.AppImage"
          fi
          if [ -f "linux-app/kiri-${VERSION}.deb" ]; then
            FILE_LIST="$FILE_LIST
            linux-app/kiri-${VERSION}.deb"
            echo "âœ… æ·»åŠ  Linux DEB: kiri-${VERSION}.deb"
          fi
          if [ -f "linux-app/kiri-${VERSION}-linux.tar.gz" ]; then
            FILE_LIST="$FILE_LIST
            linux-app/kiri-${VERSION}-linux.tar.gz"
            echo "âœ… æ·»åŠ  Linux å‹ç¼©åŒ…: kiri-${VERSION}-linux.tar.gz"
          fi
          
          # è¾“å‡ºæ–‡ä»¶åˆ—è¡¨
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "=== æœ€ç»ˆæ–‡ä»¶åˆ—è¡¨ ==="
          echo "$FILE_LIST"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: kiri ${{ github.event.inputs.version }}
          body: |
            ## ğŸ‰ åˆ» | kiri ${{ github.event.inputs.version }}
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - ç¦…æ„æç®€è®¾è®¡
            - å¯è‡ªå®šä¹‰å·¥ä½œæ—¶é—´å’Œä¼‘æ¯æ—¶é—´
            - è·¨å¹³å°æ”¯æŒ
            - ç›´è§‚çš„è¿›åº¦æŒ‡ç¤ºå™¨
            - æ™ºèƒ½çŠ¶æ€åˆ‡æ¢
            
            ### ğŸ“¦ ä¸‹è½½
            - **Android APK**: `kiri-${VERSION}.apk` - é€‚ç”¨äºAndroidè®¾å¤‡
            - **Webåº”ç”¨**: `kiri-${VERSION}-web.zip` - åŒ…å«HTMLèµ„æºçš„å‹ç¼©åŒ…
            - **iOSåº”ç”¨**: `kiri-${VERSION}-ios.zip` - é€‚ç”¨äºiOSè®¾å¤‡ï¼ˆéœ€è¦å¼€å‘è€…è¯ä¹¦ï¼‰
            - **macOSåº”ç”¨**: `kiri-${VERSION}.app` æˆ– `kiri-${VERSION}.dmg` - é€‚ç”¨äºmacOSç³»ç»Ÿ
            - **Windowsåº”ç”¨**: `kiri-${VERSION}.exe` æˆ– `kiri-${VERSION}.msi` - é€‚ç”¨äºWindowsç³»ç»Ÿ
            - **Linuxåº”ç”¨**: `kiri-${VERSION}.AppImage` æˆ– `kiri-${VERSION}.deb` - é€‚ç”¨äºLinuxç³»ç»Ÿ
            
            ### ğŸš€ å®‰è£…è¯´æ˜
            1. **Android**: ä¸‹è½½ `kiri-${VERSION}.apk` æ–‡ä»¶å¹¶å®‰è£…
            2. **Web**: ä¸‹è½½ `kiri-${VERSION}-web.zip`ï¼Œè§£å‹ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `index.html`
            3. **iOS**: ä¸‹è½½ `kiri-${VERSION}-ios.zip`ï¼Œè§£å‹åé€šè¿‡ Xcode å®‰è£…åˆ°è®¾å¤‡ï¼ˆéœ€è¦å¼€å‘è€…è¯ä¹¦ï¼‰
            4. **macOS**: ä¸‹è½½ `.app` æ–‡ä»¶ç›´æ¥è¿è¡Œï¼Œæˆ–ä¸‹è½½ `.dmg` æ–‡ä»¶å®‰è£…
            5. **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶ç›´æ¥è¿è¡Œï¼Œæˆ–ä¸‹è½½ `.msi` æ–‡ä»¶å®‰è£…
            6. **Linux**: ä¸‹è½½ `.AppImage` æ–‡ä»¶ç›´æ¥è¿è¡Œï¼Œæˆ–ä¸‹è½½ `.deb` æ–‡ä»¶å®‰è£…
            
            ### ğŸ“± ç³»ç»Ÿè¦æ±‚
            - **Android**: 5.0+ (API 21+)
            - **Web**: Chrome 60+, Firefox 55+, Safari 12+, Edge 79+
            - **iOS**: 12.0+ (éœ€è¦å¼€å‘è€…è¯ä¹¦)
            - **macOS**: 10.14+
            - **Windows**: Windows 10+
            - **Linux**: Ubuntu 18.04+
            
            ### ğŸ”§ æŠ€æœ¯æ ˆ
            - Flutter 3.35.3
            - Dart 3.0
            - Material Design 3
            
            ---
            
            *"æ—¶é—´ä¸æ˜¯æ•Œäººï¼Œè€Œæ˜¯æœ‹å‹ã€‚æ¯ä¸€åˆ»éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚"*
          files: ${{ steps.create-files.outputs.files }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          fail_on_unmatched_files: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
