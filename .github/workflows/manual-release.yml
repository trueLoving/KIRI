name: åº”ç”¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

env:
  FLUTTER_VERSION: '3.35.3'

jobs:
  # æ„å»ºæ‰€æœ‰å¹³å°
  build-all:
    name: Build All Platforms
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            artifact: android-apk
            path: build/app/outputs/flutter-apk/app-release.apk
          - os: ubuntu-latest
            platform: web
            artifact: web-app
            path: build/web
          - os: macos-latest
            platform: macos
            artifact: macos-app
            path: build/macos/Build/Products/Release
          - os: windows-latest
            platform: windows
            artifact: windows-app
            path: build/windows/runner/Release
          - os: ubuntu-latest
            platform: linux
            artifact: linux-app
            path: build/linux/x64/release/bundle

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java (Android only)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Build Android
        if: matrix.platform == 'android'
        run: flutter build apk --release

      - name: Build Web
        if: matrix.platform == 'web'
        run: flutter build web --release

      - name: Build macOS
        if: matrix.platform == 'macos'
        run: flutter build macos --release

      - name: Build Windows
        if: matrix.platform == 'windows'
        run: flutter build windows --release

      - name: Build Linux
        if: matrix.platform == 'linux'
        run: flutter build linux --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.path }}

  # åˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-all
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: List downloaded artifacts
        run: |
          echo "=== ä¸‹è½½çš„ artifacts ç»“æ„ ==="
          find . -type f -name "*.apk" -o -name "*.app" -o -name "*.exe" -o -name "*.deb" -o -name "*.tar.gz" | head -20
          echo "=== å„å¹³å°æ–‡ä»¶ ==="
          ls -la android-apk/ 2>/dev/null || echo "Android APK ä¸å­˜åœ¨"
          ls -la web-app/ 2>/dev/null || echo "Web åº”ç”¨ä¸å­˜åœ¨"
          ls -la macos-app/ 2>/dev/null || echo "macOS åº”ç”¨ä¸å­˜åœ¨"
          ls -la windows-app/ 2>/dev/null || echo "Windows åº”ç”¨ä¸å­˜åœ¨"
          ls -la linux-app/ 2>/dev/null || echo "Linux åº”ç”¨ä¸å­˜åœ¨"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ç•ªèŒ„é—¹é’Ÿ ${{ github.event.inputs.version }}
          body: |
            ## ğŸ‰ ç•ªèŒ„é—¹é’Ÿ ${{ github.event.inputs.version }}
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - ç¦…æ„æç®€è®¾è®¡
            - å¯è‡ªå®šä¹‰å·¥ä½œæ—¶é—´å’Œä¼‘æ¯æ—¶é—´
            - è·¨å¹³å°æ”¯æŒ
            - ç›´è§‚çš„è¿›åº¦æŒ‡ç¤ºå™¨
            - æ™ºèƒ½çŠ¶æ€åˆ‡æ¢
            
            ### ğŸ“¦ ä¸‹è½½
            - **Android APK**: é€‚ç”¨äºAndroidè®¾å¤‡
            - **Webåº”ç”¨**: å¯åœ¨æµè§ˆå™¨ä¸­ç›´æ¥ä½¿ç”¨
            - **macOSåº”ç”¨**: é€‚ç”¨äºmacOSç³»ç»Ÿ
            - **Windowsåº”ç”¨**: é€‚ç”¨äºWindowsç³»ç»Ÿ
            - **Linuxåº”ç”¨**: é€‚ç”¨äºLinuxç³»ç»Ÿ
            
            ### ğŸš€ å®‰è£…è¯´æ˜
            1. **Android**: ä¸‹è½½APKæ–‡ä»¶å¹¶å®‰è£…
            2. **Web**: è®¿é—®åœ¨çº¿ç‰ˆæœ¬æˆ–ä¸‹è½½Webåº”ç”¨
            3. **æ¡Œé¢**: ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            
            ### ğŸ“± ç³»ç»Ÿè¦æ±‚
            - **Android**: 5.0+ (API 21+)
            - **Web**: Chrome 60+, Firefox 55+, Safari 12+, Edge 79+
            - **macOS**: 10.14+
            - **Windows**: Windows 10+
            - **Linux**: Ubuntu 18.04+
            
            ### ğŸ”§ æŠ€æœ¯æ ˆ
            - Flutter 3.35.3
            - Dart 3.0
            - Material Design 3
            
            ---
            
            *"æ—¶é—´ä¸æ˜¯æ•Œäººï¼Œè€Œæ˜¯æœ‹å‹ã€‚æ¯ä¸€åˆ»éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚"*
          files: |
            android-apk/app-release.apk
            web-app/*
            macos-app/*.app
            macos-app/*.dmg
            windows-app/*.exe
            windows-app/*.msi
            linux-app/*
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          fail_on_unmatched_files: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
